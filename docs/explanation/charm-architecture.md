# Charm Architecture

At it's core, Indico is a flask application that requires connections to PostgreSQL, Redis, and Celery.

In designing the charm, we've leveraged the sidecar pattern to allow us to run multiple containers in each pod as follows:

1. An nginx container, which can be used to efficiently serve static resources, as well as be the incoming point for all web traffic to the pod.
2. The Indico container itself, which has a uwsgi server configured in http mode.
3. A celery container, running tasks generated by the web application.
4. A prometheus-nginx-exporter container which can be used to provide statistics on web traffic.

As a result, if you run a `kubectl get pods` on a namespace named for the Juju model you've deployed the indico charm into, you'll see something like the following:
```
NAME                             READY   STATUS    RESTARTS   AGE
indico-0                         5/5     Running   0         6h4m

```
This shows there are 5 containers - the four named above, as well as a container for the charm code itself.

Let's look at each container in turn in a bit more detail.

## Nginx container

The configuration for Nginx in this container is defined in [the files directory of the charm repository](https://github.com/canonical/indico-operator/blob/main/files/etc/nginx/nginx.conf). The workload that this container is running is defined in the [nginx dockerfile in the charm repository](https://github.com/canonical/indico-operator/blob/main/indico-nginx.Dockerfile).

As mentioned above, this container is the entry point for all web traffic to the pod (on port `8080`), and it serves some static files directly and forwards non-static requests to the indico container (on port `8081`).

## Indico container

The workload that this container is running is defined in the [indico dockerfile in the charm repository](https://github.com/canonical/indico-operator/blob/main/indico.Dockerfile).

On startup, pebble is used to start a uwsgi server in http mode, on port `8081`. Non-static traffic is forwarded here from the nginx container.

## Celery container

The celery container runs the same workload as the indico container, as defined in the [indico dockerfile in the charm repository](https://github.com/canonical/indico-operator/blob/main/indico.Dockerfile).

On startup, pebble is used to start the Celery worker. This container will be used to process tasks created by the Indico application.

## Prometheus-nginx-exporter container

This container runs the `nginx/nginx-prometheus-exporter` image. 

On startup, pebble is configured to run `nginx-prometheus-exporter` with  `-nginx.scrape-uri=http://localhost:9080/stub_status`. This has been configured in the nginx container to return nginx's [stub_status](http://nginx.org/en/docs/http/ngx_http_stub_status_module.html). The exporter listens on port `9113` and metrics about web traffic to the pod can be scraped there.
