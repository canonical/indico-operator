# Charm Architecture

At its core, [Indico](https://getindico.io/) is a [Flask](https://flask.palletsprojects.com/) application that requires connections to [PostgreSQL](https://www.postgresql.org/), [Redis](https://redis.io/), and [Celery](https://docs.celeryq.dev/en/stable/).

In designing the charm, we've leveraged the [sidecar](https://kubernetes.io/blog/2015/06/the-distributed-system-toolkit-patterns/#example-1-sidecar-containers) pattern to allow us to run multiple containers in each pod with [Pebble](https://juju.is/docs/sdk/pebble) running as the workload containerâ€™s entrypoint.

Pebble is a lightweight, API-driven process supervisor that is responsible for configuring processes to run in a container and controlling those processes throughout the workload lifecycle.

Pebble `services` are configured by means of [layers](https://github.com/canonical/pebble#layer-specification), and the following containers represent each one a layer forming the effective Pebble configuration, or `plan`:

1. An [NGINX](https://www.nginx.com/) container, which can be used to efficiently serve static resources, as well as be the incoming point for all web traffic to the pod.
2. The [Indico](https://getindico.io/) container itself, which has a [uWSGI](https://uwsgi-docs.readthedocs.io/en/latest/) server configured in HTTP mode.
3. A [Celery](https://docs.celeryq.dev/en/stable/) container, running tasks generated by the web application.
4. A [NGINX Prometheus Exporter](https://github.com/nginxinc/nginx-prometheus-exporter) container that can be used to provide statistics on web traffic.
5. A [StatsD exporter](https://github.com/prometheus/statsd_exporter) container that can be used to collect [statistics](https://uwsgi-docs.readthedocs.io/en/latest/PushingStats.html) from uWSGI.

As a result, if you run a `kubectl get pods` on a namespace named for the Juju model you've deployed the indico charm into, you'll see something like the following:

```bash
NAME                             READY   STATUS    RESTARTS   AGE
indico-0                         6/6     Running   0         6h4m
```

This shows there are 6 containers - the five named above, as well as a container for the charm code itself.

And if you run `kubectl describe pod indico-0`, all the containers will have as Command ```/charm/bin/pebble```. That's because Pebble is responsible for the processes startup as explained above.

## Containers

Configuration files for the containers can be found in [the files directory of the charm repository](https://github.com/canonical/indico-operator/tree/main/files).

### NGINX

This container is the entry point for all web traffic to the pod (on port `8080`), and it serves some static files directly and forwards non-static requests to the Indico container (on port `8081`).

The reason for that is since NGINX provides cache static content, reverse proxy, and load balance among multiple application servers, as well as other features it can be used in front of uWSGI server to significantly reduce server and network load.

The workload that this container is running is defined in the [NGINX dockerfile in the charm repository](https://github.com/canonical/indico-operator/blob/main/indico-nginx.Dockerfile).

### Indico

The uWSGI server is started in HTTP mode (port `8081`) so NGINX can forward non-static traffic to it to be handled by the Indico application.

The workload that this container is running is defined in the [indico dockerfile in the charm repository](https://github.com/canonical/indico-operator/blob/main/indico.Dockerfile).

### Celery

The Celery is used to process tasks created by the Indico application such as sending e-mails, survey notifications, event reminders, etc.

The Celery container runs the same workload as the Indico container, as defined in the [indico dockerfile in the charm repository](https://github.com/canonical/indico-operator/blob/main/indico.Dockerfile).

### NGINX Prometheus Exporter

This container runs the `nginx/nginx-prometheus-exporter` image.

The `NGINX Prometheus Exporter` is started with `-nginx.scrape-uri=http://localhost:9080/stub_status` so will scrap metrics from the NGINX container.

This has been configured in the NGINX container to return NGINX's [stub_status](http://nginx.org/en/docs/http/ngx_http_stub_status_module.html). The exporter listens on port `9113` and metrics about web traffic to the pod can be scraped by Prometheus there.

### StatsD exporter

This container runs the `prom/statsd-exporter` image.

The `StatsD exporter` listens on ports:

- `9125`: UDP address on which to receive statsd metric.
- `9102`: expose the web interface and generated Prometheus metrics. The metrics can be scraped by Prometheus here.

## Docker Images

The images defined in [NGINX dockerfile](https://github.com/canonical/indico-operator/blob/main/indico-nginx.Dockerfile) and [Indico dockerfile](https://github.com/canonical/indico-operator/blob/main/indico.Dockerfile) in the charm repository are published to [Charmhub](https://charmhub.io/), the official repository of charms.

This is done by publishing a resource to Charmhub as described in the [Juju SDK How-to guides](https://juju.is/docs/sdk/publishing).

## Integrations

### PostgreSQL

PostgreSQL is an open-source object-relational database used by Indico as a source of all the data needed for its goal: event organization, archival, and collaboration.

### Redis

Redis is an open-source in-memory data structure store used as a cache backend. Copies of frequently accessed data are stored and used if satisfy the request. Otherwise, the application will handle it. This configuration helps to reduce the number of queries and improve response latency.

## Juju Events

Accordingly to the [Juju SDK](https://juju.is/docs/sdk/event): "an event is a data structure that encapsulates part of the execution context of a charm".

For this charm, the following events are observed:

1. [<container name>_pebble_ready](https://juju.is/docs/sdk/container-name-pebble-ready-event): fired on Kubernetes charms when the requested container is ready. Action: wait for the integrations, and configure the containers.
2. [config_changed](https://juju.is/docs/sdk/config-changed-event): usually fired in response to a configuration change using the GUI or CLI. Action: wait for the integrations, validate the configuration, update Ingress, and restart the containers.
3. [leader_elected](https://juju.is/docs/sdk/leader-elected-event): is emitted for a unit that is elected as leader. Action: guarantee that all Indico workers have the same [secret key](https://docs.getindico.io/en/latest/config/settings/?highlight=secret_key#SECRET_KEY) that is used to sign tokens in URLs.
4. [refresh_external_resources_action](https://charmhub.io/indico/actions): fired when refresh-external-resources action is requested. Action: Pull changes from the customization repository, reload uWSGI and upgrade the external plugins.
5. [master_changed](https://github.com/canonical/ops-lib-pgsql): PostgreSQLClient custom event for when the connection details to the master database on this relation change. Action: Update the database connection string configuration and emit config_changed event.
