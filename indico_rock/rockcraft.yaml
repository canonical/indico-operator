# Copyright 2024 Canonical Ltd.
# See LICENSE file for licensing details.
package-repositories:
  - type: apt
    ppa: deadsnakes/ppa
    priority: always

name: indico
summary: Indico rock
description: Indico OCI image for the Indico charm
version: "1.0"
base: ubuntu@22.04
build-base: ubuntu@22.04
license: Apache-2.0
platforms:
  amd64:
parts:
  add-user:
    plugin: nil
    overlay-script: |
      chmod 755 $CRAFT_OVERLAY/etc
      groupadd -R $CRAFT_OVERLAY --gid 2000 indico
      useradd -R $CRAFT_OVERLAY --system --gid 2000 --uid 2000 --home /srv/indico indico
  indico:
    plugin: python
    build-environment:
      - PARTS_PYTHON_INTERPRETER: python3.12
      - UWSGI_EMBED_PLUGINS: stats_pusher_statsd
    python-packages:
      - setuptools
      - wheel
      - indico==3.3.1
      - indico-plugin-payment-paypal==3.3
      - indico-plugin-piwik
      - indico-plugin-storage-s3
      - python3-saml
      - uwsgi
      - ./anonymize
      - ./autocreate
    source: plugins
    build-packages:
      - python3.12-venv
      - python3.12-dev
      - build-essential
      - libpq-dev
      - libsasl2-dev
      - libxmlsec1-dev
      - pkg-config
      - wget
    stage-packages:
      - python3.12-venv
      - python3.12-dev
      - bash
      - build-essential
      - ca-certificates
      - git-core
      - libglib2.0-data
      - libpq-dev
      - libsasl2-dev
      - locales
      - logrotate
      - pkg-config
      - postgresql-client
      - shared-mime-info
      - texlive-fonts-recommended
      - texlive-plain-generic
      - texlive-xetex
      - libpangocairo-1.0-0 # required for python3.12
    overlay-packages:
      - libxmlsec1-dev
    stage-snaps:
      - celery-prometheus-exporter/latest/edge
      - gtrkiller-statsd-prometheus-exporter/latest/edge
    override-prime: |
      craftctl default
      /bin/bash -c "mkdir -p --mode=775 srv/indico/{archive,cache,custom,etc,log,tmp}"
      /bin/bash -c "chown 2000:2000 srv/indico srv/indico/{archive,cache,custom,etc,log,tmp}"
      cp $CRAFT_PART_INSTALL/lib/python3.12/site-packages/indico/web/indico.wsgi srv/indico/indico.wsgi
      cp -R $CRAFT_PART_INSTALL/lib/python3.12/site-packages/indico/web/static srv/indico/static
      # Copy root certificates
      mkdir -p etc/ssl/certs/
      cp /etc/ssl/certs/ca-certificates.crt etc/ssl/certs/
  copy-config:
    plugin: dump
    source: .
    organize:
      start-indico.sh: srv/indico/start-indico.sh
      logrotate.conf: srv/indico/logrotate.conf
    permissions:
      - owner: 2000
        group: 2000
      - path: srv/indico/start-indico.sh
        mode: "544"
      - path: etc/
        mode: "755"
    prime:
      - etc/*
      - srv/indico/start-indico.sh
      - srv/indico/logrotate.conf
