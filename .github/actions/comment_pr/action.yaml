name: Comment on PR
description: Publish a comment on a PR and remove previous bot comments
inputs:
  artifact-name:
    required: true
    description: Artifact containing a JSON like list of comments to be published
  github-token:
    required: true
    description: Github token
runs:
  using: composite
  steps:
    - name: Download test report artifact
      uses: actions/github-script@v6.2.0
      with:
        script: |
          const fs = require('fs');
          const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: ${{ github.event.workflow_run.id }},
          });
          const matchArtifact = artifacts.data.artifacts.filter((artifact) => {
            return artifact.name == '${{ inputs.artifact-name }}',
          })[0];
          const download = await github.rest.actions.downloadArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: matchArtifact.id,
              archive_format: 'zip',
          });
          fs.writeFileSync('${{ inputs.artifact-name }}.zip', Buffer.from(download.data));
    - shell: bash
      run: unzip ${{ inputs.artifact-name }}.zip
    - name: Comment on PR
      uses: actions/github-script@v6.2.0
      with:
        github-token: ${{ inputs.github-token }}
        script: |
          const script = require('.github/actions/comment_pr/dist/comment_pr.js')
          await script({github, context})
