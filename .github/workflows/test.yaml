name: Tests

on:
  pull_request:
  push:
    branches:
      - 'feat/linters'

jobs:
  docker-lint:
    runs-on: ubuntu-22.04
    name: Dockerfile lint
    steps:
      - uses: actions/checkout@v3
      - name: Check for Dockerfiles
        run: echo Dockerfiles=$(find . -name "*Dockerfile") >> $GITHUB_ENV
      - if: ${{ env.Dockerfiles != '' }}
        name: Run hadolint on Dockerfiles
        uses: jbergstroem/hadolint-gh-action@v1
        with:
          dockerfile: "${{ env.Dockerfiles }}"

  shellcheck-lint:
    runs-on: ubuntu-22.04
    name: Shell scripts lint
    steps:
      - uses: actions/checkout@v3
      - name: Gather files to scan
        shell: bash
        run: |
          declare -a filepaths
          shebangregex="^#! */[^ ]*/(env *)?[abk]*sh"

          set -f # temporarily disable globbing so that globs in inputs aren't expanded

          while IFS= read -r -d '' file; do
          filepaths+=("$file")
          done < <(find . \
                        -type f \
                        '(' \
                        -name '*.bash' \
                        -o -name '.bashrc' \
                        -o -name 'bashrc' \
                        -o -name '.bash_aliases' \
                        -o -name '.bash_completion' \
                        -o -name '.bash_login' \
                        -o -name '.bash_logout' \
                        -o -name '.bash_profile' \
                        -o -name 'bash_profile' \
                        -o -name '*.ksh' \
                        -o -name 'suid_profile' \
                        -o -name '*.zsh' \
                        -o -name '.zlogin' \
                        -o -name 'zlogin' \
                        -o -name '.zlogout' \
                        -o -name 'zlogout' \
                        -o -name '.zprofile' \
                        -o -name 'zprofile' \
                        -o -name '.zsenv' \
                        -o -name 'zsenv' \
                        -o -name '.zshrc' \
                        -o -name 'zshrc' \
                        -o -name '*.sh' \
                        -o -path '*/.profile' \
                        -o -path '*/profile' \
                        -o -name '*.shlib' \
                        ')' \
                        -print0)

          while IFS= read -r -d '' file; do
          head -n1 "$file" | grep -Eqs "$shebangregex" || continue
          filepaths+=("$file")
          done < <(find . \
                        -type f ! -name '*.*' -perm /111 \
                        -print0)
          echo "filepaths=${filepaths[@]}" >> $GITHUB_ENV 
          set +f # re-enable globbing
    - name: Run ShellCheck
      uses: lumaxis/shellcheck-problem-matchers@v1
    - run: shellcheck -f gcc ${filepaths}
      #unit-tests:
      #uses: canonical/operator-workflows/.github/workflows/test.yaml@feat/linters
      #secrets: inherit
