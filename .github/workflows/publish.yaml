name: Publish charm

on:
  workflow_call:
    inputs:
      channel:
        type: string
        required: true
    secrets:
      charmhub-token:
        required: true

jobs:
  publish-indico-image:
    runs-on: ubuntu-latest
    steps:
      - uses: ./.github/actions/publish_oci_resource
        with:
          dockerfile: indico.Dockerfile
          charm-name: indico
          resource-name: indico-image
          charmhub-token: ${{ secrets.charmhub-token }}
  publish-nginx-image:
    runs-on: ubuntu-latest
    steps:
      - uses: ./.github/actions/publish_oci_resource
        with:
          dockerfile: indico-nginx.Dockerfile
          charm-name: indico
          resource-name: indico-nginx-image
          charmhub-token: ${{ secrets.charmhub-token }}
  publish-charm:
    runs-on: ubuntu-latest
    needs: [publish-indico-image, publish-nginx-image]
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Upload charm to charmhub
        uses: canonical/charming-actions/upload-charm@1.0.3
        with:
          credentials: ${{ secrets.charmhub-token }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          channel: ${{ github.event.inputs.channel }}
          upload-image: false


