name: Change Artifact Enforcement

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  check-change-artifact:
    name: Validate Change Artifact
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyYAML jsonschema
      
      - name: Get PR number and changed files
        id: pr-info
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          
          # Get changed files
          gh pr view $PR_NUMBER --json files --jq '.files[].path' > changed_files.txt
          echo "Changed files:"
          cat changed_files.txt
      
      - name: Check for exemption labels
        id: check-exempt
        run: |
          LABELS="${{ join(github.event.pull_request.labels.*.name, ',') }}"
          echo "Labels: $LABELS"
          
          if echo "$LABELS" | grep -qE 'no-changelog|docs-only|tests-only|maintenance'; then
            echo "exempt=true" >> $GITHUB_OUTPUT
            echo "reason=Exempt via label: $LABELS" >> $GITHUB_OUTPUT
          else
            echo "exempt=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Detect if artifact required
        id: detect-scope
        if: steps.check-exempt.outputs.exempt != 'true'
        run: |
          # Run detection logic and capture output
          python3 << 'EOF' >> $GITHUB_OUTPUT
          import re
          from pathlib import Path
          
          # Patterns that require artifacts
          IN_SCOPE_PATTERNS = [
              r'^src/.*\.py$',
              r'^lib/charms/.*\.py$',
              r'^config\.yaml$',
              r'^actions\.yaml$',
              r'^metadata\.yaml$',
              r'^charmcraft\.yaml$',
              r'.*rockcraft\.yaml$',
              r'^requirements\.txt$',
              r'^pyproject\.toml$',
              r'^\.github/workflows/.*\.yaml$',
              r'^tox\.ini$',
              r'^Makefile$'
          ]
          
          # Patterns that are exempt
          EXEMPT_PATTERNS = [
              r'^docs/.*',
              r'^tests/.*',
              r'.*\.md$',
              r'^\.gitignore$',
              r'^\.editorconfig$',
              r'^renovate\.json$',
              r'^\.github/agents/.*',
              r'^.*\.sh$'
          ]
          
          def matches_pattern(file_path, patterns):
              return any(re.match(pattern, file_path) for pattern in patterns)
          
          # Read changed files
          changed_files = Path('changed_files.txt').read_text().strip().split('\n')
          changed_files = [f for f in changed_files if f]
          
          requires_artifact = False
          in_scope_files = []
          
          for file_path in changed_files:
              if matches_pattern(file_path, EXEMPT_PATTERNS):
                  continue
              if matches_pattern(file_path, IN_SCOPE_PATTERNS):
                  requires_artifact = True
                  in_scope_files.append(file_path)
          
          # Output to GITHUB_OUTPUT
          if requires_artifact:
              print(f"requires_artifact=true")
              print(f"in_scope_files={','.join(in_scope_files)}")
          else:
              print(f"requires_artifact=false")
          EOF
      
      - name: Check artifact exists
        id: check-artifact
        if: steps.detect-scope.outputs.requires_artifact == 'true'
        run: |
          PR_NUMBER="${{ steps.pr-info.outputs.pr_number }}"
          ARTIFACT_PATH="docs/release-notes/artifacts/pr${PR_NUMBER}.yaml"
          
          if [ -f "$ARTIFACT_PATH" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "path=$ARTIFACT_PATH" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "path=$ARTIFACT_PATH" >> $GITHUB_OUTPUT
          fi
      
      - name: Validate artifact schema
        id: validate-schema
        if: steps.check-artifact.outputs.exists == 'true'
        run: |
          # Run validation and write results directly to output and file
          python3 << 'EOF' | tee validation_output.txt >> $GITHUB_OUTPUT
          import yaml
          
          artifact_path = "${{ steps.check-artifact.outputs.path }}"
          
          try:
              with open(artifact_path, 'r') as f:
                  artifact = yaml.safe_load(f)
              
              errors = []
              
              # Validate schema_version
              if 'schema_version' not in artifact:
                  errors.append("Missing required field: schema_version")
              elif artifact['schema_version'] != 1:
                  errors.append(f"Invalid schema_version: {artifact['schema_version']} (must be 1)")
              
              # Validate changes array
              if 'changes' not in artifact:
                  errors.append("Missing required field: changes")
              elif not isinstance(artifact['changes'], list) or len(artifact['changes']) == 0:
                  errors.append("Field 'changes' must be a non-empty array")
              else:
                  for i, change in enumerate(artifact['changes']):
                      required_fields = ['title', 'author', 'type', 'description', 'urls', 'visibility', 'highlight']
                      for field in required_fields:
                          if field not in change:
                              errors.append(f"changes[{i}]: Missing required field: {field}")
                      
                      if 'title' in change and (not change['title'] or len(change['title']) < 10):
                          errors.append(f"changes[{i}].title: Too short (min 10 characters)")
                      
                      if 'type' in change:
                          valid_types = ['minor', 'major', 'breaking', 'security', 'bugfix']
                          if change['type'] not in valid_types:
                              errors.append(f"changes[{i}].type: Invalid value (must be one of: minor, major, breaking, security, bugfix)")
                      
                      if 'description' in change and (not change['description'] or len(change['description']) < 20):
                          errors.append(f"changes[{i}].description: Too short (min 20 characters)")
                      
                      if 'visibility' in change and change['visibility'] not in ['public', 'internal']:
                          errors.append(f"changes[{i}].visibility: Invalid value (must be public or internal)")
                      
                      if 'urls' in change and 'pr' not in change['urls']:
                          errors.append(f"changes[{i}].urls: Missing required field: pr")
              
              # Write results
              if errors:
                  print("valid=false")
                  print(f"error_count={len(errors)}")
                  # Write errors to file for later use
                  with open('validation_errors.txt', 'w') as f:
                      f.write('\n'.join(errors))
              else:
                  print("valid=true")
          
          except Exception as e:
              print("valid=false")
              print("error_count=1")
              with open('validation_errors.txt', 'w') as f:
                  f.write(f"Validation error: {str(e)}")
          EOF
      
      - name: Create status comment
        if: always()
        uses: actions/github-script@v7
        env:
          EXEMPT: ${{ steps.check-exempt.outputs.exempt }}
          REQUIRES_ARTIFACT: ${{ steps.detect-scope.outputs.requires_artifact }}
          ARTIFACT_EXISTS: ${{ steps.check-artifact.outputs.exists }}
          ARTIFACT_VALID: ${{ steps.validate-schema.outputs.valid }}
          PR_NUMBER: ${{ steps.pr-info.outputs.pr_number }}
          IN_SCOPE_FILES: ${{ steps.detect-scope.outputs.in_scope_files }}
        with:
          script: |
            const exempt = process.env.EXEMPT === 'true';
            const requiresArtifact = process.env.REQUIRES_ARTIFACT === 'true';
            const artifactExists = process.env.ARTIFACT_EXISTS === 'true';
            const artifactValid = process.env.ARTIFACT_VALID === 'true';
            const prNumber = process.env.PR_NUMBER;
            const inScopeFiles = process.env.IN_SCOPE_FILES;
            
            let status = 'success';
            let message = '';
            
            if (exempt) {
              message = `â„¹ï¸ **Change Artifact Check: EXEMPT**\n\nThis PR is exempt from change artifact requirements.\n\nNo change artifact required.`;
            } else if (!requiresArtifact) {
              message = `âœ… **Change Artifact Check: PASSED**\n\nNo in-scope changes detected that require a change artifact.\n\nChanged files are documentation, tests, or other exempt categories.`;
            } else if (!artifactExists) {
              status = 'failure';
              const filesList = inScopeFiles ? inScopeFiles.split(',').map(f => `- ${f}`).join('\n') : '';
              message = `âŒ **Change Artifact Check: FAILED**\n\n**Issue**: Missing change artifact\n\n**Required**: This PR modifies in-scope files and requires a change artifact.\n\n**Changed Files Requiring Artifact**:\n${filesList}\n\n**Action Required**: Create \`docs/release-notes/artifacts/pr${prNumber}.yaml\`\n\n### ðŸ“ Template for Your Change Artifact\n\n\`\`\`yaml\n# --- Release notes artifact ----\n\nschema_version: 1\nchanges:\n  - title: "Brief description of your change"\n    author: ${{ github.event.pull_request.user.login }}\n    type: minor  # Options: minor, major, breaking, security, bugfix\n    description: |\n      Detailed description of what changed and why.\n      Include context that will help users understand the impact.\n    urls: \n      pr: https://github.com/${{ github.repository }}/pull/${prNumber}\n      related_doc: ""\n      related_issue: ""\n    visibility: public  # Options: public, internal\n    highlight: false  # Set to true for significant changes\n\`\`\`\n\n**Examples**: See existing artifacts in \`docs/release-notes/artifacts/\`\n\n**Documentation**: See \`docs/release-notes/template/_change-artifact-template.yaml\``;
            } else if (!artifactValid) {
              status = 'failure';
              let errors = '';
              try {
                const fs = require('fs');
                if (fs.existsSync('validation_errors.txt')) {
                  errors = fs.readFileSync('validation_errors.txt', 'utf8');
                }
              } catch (e) {
                errors = 'Unable to read validation errors';
              }
              message = `âŒ **Change Artifact Check: FAILED**\n\n**Issue**: Invalid change artifact schema\n\n**Found**: \`docs/release-notes/artifacts/pr${prNumber}.yaml\`\n\n**Schema Errors**:\n\`\`\`\n${errors}\n\`\`\`\n\n**Template**: See \`docs/release-notes/template/_change-artifact-template.yaml\``;
            } else {
              message = `âœ… **Change Artifact Check: PASSED**\n\nFound valid change artifact at: \`docs/release-notes/artifacts/pr${prNumber}.yaml\`\n\nAll requirements met. Ready for review.`;
            }
            
            // Post comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            const botComment = comments.find(c => 
              c.user.type === 'Bot' && 
              c.body.includes('Change Artifact Check')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: message
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: message
              });
            }
            
            // Set check status
            if (status === 'failure') {
              core.setFailed('Change artifact validation failed');
            }
